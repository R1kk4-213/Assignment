{% extends "admin_base.html" %}

{% block title %}Reports - TutorHub{% endblock %}

{% block admin_extra_css %}
<style>
    /* Reports Specific Styles */
    .reports-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
    }
    
    .report-selector {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .report-select {
        padding: 10px 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        color: #1f2937;
        background-color: white;
        cursor: pointer;
        min-width: 200px;
    }
    
    .export-btn {
        background: #6366f1;
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .export-btn:hover {
        background: #4f46e5;
        transform: translateY(-1px);
    }
    
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 24px;
        margin-top: 24px;
    }
    
    .chart-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        border: 1px solid #e5e7eb;
    }
    
    .chart-title {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 8px;
    }
    
    .chart-subtitle {
        font-size: 13px;
        color: #6b7280;
        margin-bottom: 20px;
    }
    
    .chart-wrapper {
        position: relative;
        height: 300px;
    }
    
    @media (max-width: 1024px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block admin_content %}
        <!-- Page Title & Controls -->
        <div class="reports-header">
            <h1 class="page-title">Reports Overview</h1>
            <div class="report-selector">
                <select class="report-select" id="periodSelector">
                    <option value="monthly" {% if current_period == 'monthly' %}selected{% endif %}>Monthly Summary</option>
                    <option value="quarterly" {% if current_period == 'quarterly' %}selected{% endif %}>Quarterly Summary</option>
                    <option value="yearly" {% if current_period == 'yearly' %}selected{% endif %}>Yearly Summary</option>
                </select>
                <button class="export-btn">Export Report</button>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="charts-grid">
            <!-- Website Traffic Chart -->
            <div class="chart-card">
                <h2 class="chart-title">Website Traffic</h2>
                <p class="chart-subtitle" id="trafficSubtitle">{% if current_period == 'yearly' %}Yearly{% elif current_period == 'quarterly' %}Quarterly{% else %}Monthly{% endif %} page views and clicks</p>
                <div class="chart-wrapper">
                    <canvas id="trafficChart"></canvas>
                </div>
            </div>

            <!-- Enrollment Trends Chart -->
            <div class="chart-card">
                <h2 class="chart-title">Enrollment Trends</h2>
                <p class="chart-subtitle" id="enrollmentSubtitle">{% if current_period == 'yearly' %}Yearly{% elif current_period == 'quarterly' %}Quarterly{% else %}Monthly{% endif %} inquiries and enrollments</p>
                <div class="chart-wrapper">
                    <canvas id="enrollmentChart"></canvas>
                </div>
            </div>
        </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script>
// Get data from backend
const reportsData = {{ reports_data | tojson }};

// Website Traffic Chart Data
const trafficData = {
    labels: reportsData.traffic.labels,
    datasets: [
        {
            label: 'Page Views',
            data: reportsData.traffic.page_views,
            backgroundColor: '#3b82f6',
            borderRadius: 6,
            barThickness: 30
        },
        {
            label: 'Clicks',
            data: reportsData.traffic.clicks,
            backgroundColor: '#1e3a8a',
            borderRadius: 6,
            barThickness: 30
        }
    ]
};

// Website Traffic Chart Config
const trafficConfig = {
    type: 'bar',
    data: trafficData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: true,
                position: 'bottom',
                labels: {
                    usePointStyle: true,
                    padding: 15,
                    font: { size: 12 }
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                borderRadius: 8
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    font: { size: 11 },
                    color: '#9ca3af'
                },
                grid: {
                    color: '#e5e7eb',
                    drawBorder: false
                }
            },
            x: {
                grid: { display: false },
                ticks: {
                    font: { size: 11 },
                    color: '#6b7280'
                }
            }
        }
    }
};

// Enrollment Trends Chart Data
const enrollmentData = {
    labels: reportsData.enrollment.labels,
    datasets: [
        {
            label: 'Inquiries',
            data: reportsData.enrollment.inquiries,
            borderColor: '#60a5fa',
            backgroundColor: 'rgba(96, 165, 250, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointBackgroundColor: '#60a5fa'
        },
        {
            label: 'Enrollments',
            data: reportsData.enrollment.enrollments,
            borderColor: '#1e3a8a',
            backgroundColor: 'rgba(30, 58, 138, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointBackgroundColor: '#1e3a8a'
        }
    ]
};

// Enrollment Trends Chart Config
const enrollmentConfig = {
    type: 'line',
    data: enrollmentData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: true,
                position: 'bottom',
                labels: {
                    usePointStyle: true,
                    padding: 15,
                    font: { size: 12 }
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                borderRadius: 8
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    font: { size: 11 },
                    color: '#9ca3af'
                },
                grid: {
                    color: '#e5e7eb',
                    drawBorder: false
                }
            },
            x: {
                grid: { display: false },
                ticks: {
                    font: { size: 11 },
                    color: '#6b7280'
                }
            }
        }
    }
};

// Render Charts
window.addEventListener('DOMContentLoaded', function() {
    const trafficCtx = document.getElementById('trafficChart');
    const enrollmentCtx = document.getElementById('enrollmentChart');
    
    if (trafficCtx) {
        new Chart(trafficCtx, trafficConfig);
    }
    
    if (enrollmentCtx) {
        new Chart(enrollmentCtx, enrollmentConfig);
    }
    
    // Period Selector Change Handler
    document.getElementById('periodSelector').addEventListener('change', function() {
        const selectedPeriod = this.value;
        window.location.href = `{{ url_for('reports') }}?period=${selectedPeriod}`;
    });
    
    // Export Report Button
    document.querySelector('.export-btn').addEventListener('click', function() {
        const period = document.getElementById('periodSelector').value;
        const periodText = period.charAt(0).toUpperCase() + period.slice(1);
        
        // Create CSV content
        let csvContent = `TutorHub - ${periodText} Report\n`;
        csvContent += `Generated: ${new Date().toLocaleString()}\n\n`;
        
        // Website Traffic Data
        csvContent += `Website Traffic (${periodText})\n`;
        csvContent += `Period,Page Views,Clicks\n`;
        reportsData.traffic.labels.forEach((label, index) => {
            csvContent += `${label},${reportsData.traffic.page_views[index]},${reportsData.traffic.clicks[index]}\n`;
        });
        
        csvContent += `\n`;
        
        // Enrollment Trends Data
        csvContent += `Enrollment Trends (${periodText})\n`;
        csvContent += `Period,Inquiries,Enrollments\n`;
        reportsData.enrollment.labels.forEach((label, index) => {
            csvContent += `${label},${reportsData.enrollment.inquiries[index]},${reportsData.enrollment.enrollments[index]}\n`;
        });
        
        // Create download link
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', `TutorHub_${periodText}_Report_${new Date().toISOString().slice(0,10)}.csv`);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });
});
</script>
{% endblock %}
