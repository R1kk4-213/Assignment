{% extends "base.html" %}

{% block title %}Reports - TutorHub{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<style>
    /* Hide navbar and footer for dashboard pages */
    body .navbar,
    body footer {
        display: none !important;
    }
    body {
        padding-top: 0 !important;
    }
    /* Flash messages positioning */
    .flash-messages-container {
        top: 20px;
        right: 20px;
        z-index: 10000;
    }
    
    /* Reports Specific Styles */
    .reports-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
    }
    
    .report-selector {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .report-select {
        padding: 10px 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        color: #1f2937;
        background-color: white;
        cursor: pointer;
        min-width: 200px;
    }
    
    .export-btn {
        background: #6366f1;
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .export-btn:hover {
        background: #4f46e5;
        transform: translateY(-1px);
    }
    
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 24px;
        margin-top: 24px;
    }
    
    .chart-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        border: 1px solid #e5e7eb;
    }
    
    .chart-title {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 8px;
    }
    
    .chart-subtitle {
        font-size: 13px;
        color: #6b7280;
        margin-bottom: 20px;
    }
    
    .chart-wrapper {
        position: relative;
        height: 300px;
    }
    
    @media (max-width: 1024px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-wrapper">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo-section">
            <img src="{{ url_for('static', filename='img/hcmut/LogoHcmut.jpg') }}" alt="HCMUT Logo" class="logo-image" style="width: 50px; height: 50px; object-fit: contain; border-radius: 8px;">
            <span class="logo-text">TutorHub</span>
        </div>

        <nav class="sidebar-nav">
            <a href="{{ url_for('dashboard') }}" class="nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <polyline points="9 22 9 12 15 12 15 22" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Home</span>
            </a>

            <a href="{{ url_for('tutor_management') }}" class="nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="9" cy="7" r="4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Tutor Management</span>
            </a>

            <a href="{{ url_for('configuration') }}" class="nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <circle cx="12" cy="12" r="3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 1v6m0 6v6m8.66-15.66l-4.24 4.24m-8.49 8.49l-4.24 4.24M23 12h-6m-6 0H1m15.66 8.66l-4.24-4.24m-8.49-8.49l-4.24-4.24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Configuration</span>
            </a>

            <a href="{{ url_for('reports') }}" class="nav-item active">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M3 3v18h18" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M18 17l-5-5-3 3-5-5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Reports</span>
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Page Title & Controls -->
        <div class="reports-header">
            <h1 class="page-title">Reports Overview</h1>
            <div class="report-selector">
                <select class="report-select" id="periodSelector">
                    <option value="monthly" {% if current_period == 'monthly' %}selected{% endif %}>Monthly Summary</option>
                    <option value="quarterly" {% if current_period == 'quarterly' %}selected{% endif %}>Quarterly Summary</option>
                    <option value="yearly" {% if current_period == 'yearly' %}selected{% endif %}>Yearly Summary</option>
                </select>
                <button class="export-btn">Export Report</button>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="charts-grid">
            <!-- Website Traffic Chart -->
            <div class="chart-card">
                <h2 class="chart-title">Website Traffic</h2>
                <p class="chart-subtitle" id="trafficSubtitle">{% if current_period == 'yearly' %}Yearly{% elif current_period == 'quarterly' %}Quarterly{% else %}Monthly{% endif %} page views and clicks</p>
                <div class="chart-wrapper">
                    <canvas id="trafficChart"></canvas>
                </div>
            </div>

            <!-- Enrollment Trends Chart -->
            <div class="chart-card">
                <h2 class="chart-title">Enrollment Trends</h2>
                <p class="chart-subtitle" id="enrollmentSubtitle">{% if current_period == 'yearly' %}Yearly{% elif current_period == 'quarterly' %}Quarterly{% else %}Monthly{% endif %} inquiries and enrollments</p>
                <div class="chart-wrapper">
                    <canvas id="enrollmentChart"></canvas>
                </div>
            </div>
        </div>
    </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script>
// Get data from backend
const reportsData = {{ reports_data | tojson }};

// Website Traffic Chart Data
const trafficData = {
    labels: reportsData.traffic.labels,
    datasets: [
        {
            label: 'Page Views',
            data: reportsData.traffic.page_views,
            backgroundColor: '#3b82f6',
            borderRadius: 6,
            barThickness: 30
        },
        {
            label: 'Clicks',
            data: reportsData.traffic.clicks,
            backgroundColor: '#1e3a8a',
            borderRadius: 6,
            barThickness: 30
        }
    ]
};

// Website Traffic Chart Config
const trafficConfig = {
    type: 'bar',
    data: trafficData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: true,
                position: 'bottom',
                labels: {
                    usePointStyle: true,
                    padding: 15,
                    font: { size: 12 }
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                borderRadius: 8
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    font: { size: 11 },
                    color: '#9ca3af'
                },
                grid: {
                    color: '#e5e7eb',
                    drawBorder: false
                }
            },
            x: {
                grid: { display: false },
                ticks: {
                    font: { size: 11 },
                    color: '#6b7280'
                }
            }
        }
    }
};

// Enrollment Trends Chart Data
const enrollmentData = {
    labels: reportsData.enrollment.labels,
    datasets: [
        {
            label: 'Inquiries',
            data: reportsData.enrollment.inquiries,
            borderColor: '#60a5fa',
            backgroundColor: 'rgba(96, 165, 250, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointBackgroundColor: '#60a5fa'
        },
        {
            label: 'Enrollments',
            data: reportsData.enrollment.enrollments,
            borderColor: '#1e3a8a',
            backgroundColor: 'rgba(30, 58, 138, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointBackgroundColor: '#1e3a8a'
        }
    ]
};

// Enrollment Trends Chart Config
const enrollmentConfig = {
    type: 'line',
    data: enrollmentData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: true,
                position: 'bottom',
                labels: {
                    usePointStyle: true,
                    padding: 15,
                    font: { size: 12 }
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                borderRadius: 8
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    font: { size: 11 },
                    color: '#9ca3af'
                },
                grid: {
                    color: '#e5e7eb',
                    drawBorder: false
                }
            },
            x: {
                grid: { display: false },
                ticks: {
                    font: { size: 11 },
                    color: '#6b7280'
                }
            }
        }
    }
};

// Render Charts
window.addEventListener('DOMContentLoaded', function() {
    const trafficCtx = document.getElementById('trafficChart');
    const enrollmentCtx = document.getElementById('enrollmentChart');
    
    if (trafficCtx) {
        new Chart(trafficCtx, trafficConfig);
    }
    
    if (enrollmentCtx) {
        new Chart(enrollmentCtx, enrollmentConfig);
    }
    
    // Period Selector Change Handler
    document.getElementById('periodSelector').addEventListener('change', function() {
        const selectedPeriod = this.value;
        window.location.href = `{{ url_for('reports') }}?period=${selectedPeriod}`;
    });
    
    // Export Report Button
    document.querySelector('.export-btn').addEventListener('click', function() {
        const period = document.getElementById('periodSelector').value;
        const periodText = period.charAt(0).toUpperCase() + period.slice(1);
        
        // Create CSV content
        let csvContent = `TutorHub - ${periodText} Report\n`;
        csvContent += `Generated: ${new Date().toLocaleString()}\n\n`;
        
        // Website Traffic Data
        csvContent += `Website Traffic (${periodText})\n`;
        csvContent += `Period,Page Views,Clicks\n`;
        reportsData.traffic.labels.forEach((label, index) => {
            csvContent += `${label},${reportsData.traffic.page_views[index]},${reportsData.traffic.clicks[index]}\n`;
        });
        
        csvContent += `\n`;
        
        // Enrollment Trends Data
        csvContent += `Enrollment Trends (${periodText})\n`;
        csvContent += `Period,Inquiries,Enrollments\n`;
        reportsData.enrollment.labels.forEach((label, index) => {
            csvContent += `${label},${reportsData.enrollment.inquiries[index]},${reportsData.enrollment.enrollments[index]}\n`;
        });
        
        // Create download link
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', `TutorHub_${periodText}_Report_${new Date().toISOString().slice(0,10)}.csv`);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });
});
</script>
{% endblock %}
